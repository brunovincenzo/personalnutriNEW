<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Assinatura - Teste IAP</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 20px; }
    .container { max-width: 640px; margin: 0 auto; }
    .row button { display:block; width:100%; padding:12px; margin-bottom:10px; font-size:16px }
  </style>
</head>
<body>
<main>
  <div class="container">
    <h4>Assinaturas (ambiente de teste)</h4>
    <p>Use estes botões para testar a ponte JS → iOS e as respostas de IAP.</p>

    <div class="row center-align">
        <button id="btnMensal" class="btn blue">Mensal</button>
        <button id="btnSemestral" class="btn orange">Semestral</button>
        <button id="btnAnual" class="btn green">Anual</button>
        <button id="btnRestore" class="btn grey">Restaurar Compras</button>

        <!-- BOTÃO DE TESTE DA BRIDGE -->
        <button id="btnTesteIAP" class="btn red">TESTE IAP BRIDGE</button>
    </div>

    <pre id="log" style="background:#f6f6f6;padding:10px;margin-top:15px;white-space:pre-wrap;height:160px;overflow:auto"></pre>
  </div>
</main>

<script>
const PRODUCTS = {
    mensal: 'com.t800solucoes.personalnutri.mensal.1',
    semestral: 'com.t800solucoes.personalnutri.semestral.1',
    anual: 'com.t800solucoes.personalnutri.anual.1'
};

// Valores podem ser sobrescritos pela injeção de JS do app (WKUserScript)
window.USER_EMAIL = window.USER_EMAIL || 'teste@local';
window.APP_UUID = window.APP_UUID || '00000000-0000-0000-0000-000000000000';

function log(msg) {
  const el = document.getElementById('log');
  el.textContent = (new Date()).toLocaleTimeString() + ' - ' + msg + '\n' + el.textContent;
}

function isIOSBridge() {
    return window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.iap;
}

function purchaseProduct(type) {
    if (!isIOSBridge()) {
        log("Assinaturas: só funcionam dentro do app (bridge ausente)");
        alert("Assinaturas funcionam somente dentro do app.");
        return;
    }

    window.webkit.messageHandlers.iap.postMessage({
        action: "purchase",
        productId: PRODUCTS[type],
        appAccountToken: window.APP_UUID
    });
}

function restorePurchases() {
    if (!isIOSBridge()) {
        log("Restore: bridge ausente");
        alert("Restaurar funciona somente dentro do app.");
        return;
    }

    window.webkit.messageHandlers.iap.postMessage({
        action: "restore"
    });
}

/* TESTE DA BRIDGE */
function testIAPBridge() {
    log("Teste: botão clicado.");
    if (!isIOSBridge()) {
        log("Handler iap NÃO existe!");
        alert("Ponte iap ausente — rode dentro do app.");
        return;
    }
    log("Handler iap existe — enviando debug...");

    window.webkit.messageHandlers.iap.postMessage({
        action: "debug",
        origem: "pagina_assinatura",
        timestamp: Date.now()
    });
}

window.iapResult = function(result) {
    log('Recebido iapResult: ' + JSON.stringify(result));
    alert('Resultado IAP: ' + JSON.stringify(result));
}

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('btnMensal').onclick = () => purchaseProduct('mensal');
    document.getElementById('btnSemestral').onclick = () => purchaseProduct('semestral');
    document.getElementById('btnAnual').onclick = () => purchaseProduct('anual');
    document.getElementById('btnRestore').onclick = restorePurchases;
    document.getElementById('btnTesteIAP').onclick = testIAPBridge;

    log('Página pronta. USER_EMAIL=' + window.USER_EMAIL + ' APP_UUID=' + window.APP_UUID);
});
</script>
</body>
</html>
